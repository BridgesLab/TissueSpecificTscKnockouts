---
title: "Post High Protein Diet CLAMS"
author: "Innocence Harvey and Dave Bridges"
date: "May 29, 2015"
output:
  pdf_document:
    keep_tex: yes
  html_document:
    keep_md: yes
---

```{r global_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(scipen=3,digits =4)
```

```{r data-entry}
library(xlsx)
mri_data_file <- 'CLAMS MRI Data.xlsx'
mri_data <- read.xlsx2(mri_data_file, sheetIndex=1)
mri_data$Treatment <- relevel(mri_data$Treatment, ref='Control Diet')
mri_data$Lean <- as.numeric(as.character(mri_data$Lean))
mri_data$Fat <- as.numeric(as.character(mri_data$Fat))
mri_data$Weight <- as.numeric(as.character(mri_data$Weight))

clams_data_file2 <- 'oxymax data part 2.csv'
  data <- read.csv('oxymax data.csv')
  data2 <- read.csv(clams_data_file2)
  data2$Interval <- data2$Interval + max(data$Interval)
  all.data <- rbind(data, data2)

all.data$Subject <- as.factor(all.data$Subject)
remove.intervals <- 20
remove.mice <- c()
all.data.clean <- subset(all.data, Interval>remove.intervals)
all.data.clean <- subset(all.data.clean, Event.Log=='')
#remove first run's extra data
#remove bad data

library(dplyr)
merged_data <- 
  all.data.clean %>%
  inner_join(mri_data, by=c('Subject'='Label')) %>%
  select(Subject,Interval,Date.Time, Light.Dark,Volume.O2, RER,Heat,Feed.Weight.1,
         X.Ambulatory,Y.Ambulatory,
         Treatment, Fat, Lean) %>%
  mutate(Total.Weight = Lean + Fat,
         VO2 = Volume.O2 * Total.Weight/1000,
         Percent.Fat.Mass = Fat/Total.Weight*100,
         Total.Activity = X.Ambulatory)

merged_data$Time <- sapply(strsplit(as.character(merged_data$Date.Time), " "), "[[", 2)
library(lubridate)
merged_data$Time <- as.numeric(hms(merged_data$Time))
merged_data$Time.Interval <- cut(merged_data$Time, 48)
merged_data$Date.Time <- mdy_hms(as.character(merged_data$Date.Time))
```

The input files were `r mri_data_file` for the echoMRI data.  This script was most recently updated on `r date()` and includes the following number of animals.

The following animals/data were removed from this analysis due to data that was either not collected (ie measurements after the run was complete) or data that was clearly incorrect (airflow problems):

```{r summary-table, results='asis'}
library(xtable)

mri_table <- 
  mri_data %>%
  distinct(Label) %>%
  group_by(Treatment) %>%
  summarise(Males = length(Treatment))

summary_table <- 
  merged_data %>%
  distinct(Subject) %>%
  group_by(Treatment) %>%
  summarise(Males = length(Treatment))
kable(summary_table)
```

```{r analysis}
library(reshape2)
se <- function(x) sd(x)/sqrt(length(x))

animal.time.course <-
  merged_data %>%
  group_by(Treatment,Interval, Time, Light.Dark) %>%
  summarize(VO2 = mean(VO2),
            RER = mean(RER),
            Total.Activity = mean(Total.Activity),
            Lean.Mass = mean(Lean),
            Fat.Mass = mean(Fat),
            Percent.Fat.Mass = mean(Percent.Fat.Mass),
            Body.Weight = mean(Total.Weight)) %>%
  mutate(VO2.lbm = VO2/Lean.Mass)

animal.summary <-
  merged_data %>%
  group_by(Subject,Treatment,Light.Dark) %>%
  summarize(VO2 = mean(VO2),
            RER = mean(RER),
            Total.Activity = mean(Total.Activity),
            Lean.Mass = mean(Lean),
            Fat.Mass = mean(Fat),
            Percent.Fat.Mass = mean(Percent.Fat.Mass),
            Body.Weight = mean(Total.Weight)) %>%
  mutate(VO2.lbm = VO2/Lean.Mass)

grouped.summary <-
  animal.summary %>%
  group_by(Treatment,Light.Dark) %>%
  summarize(VO2 = mean(VO2),
            VO2.lbm = mean(VO2.lbm),
            RER = mean(RER),
            Total.Activity = mean(Total.Activity),
            Lean.Mass = mean(Lean.Mass),
            Fat.Mass = mean(Fat.Mass),
            Percent.Fat.Mass = mean(Percent.Fat.Mass),
            Body.Weight = mean(Body.Weight)) %>%
  rename(Light.Dark=Light.Dark)

grouped.summary.se <-
  animal.summary %>%
  group_by(Treatment,Light.Dark) %>%
  summarize(VO2 = se(VO2),
            VO2.lbm = se(VO2.lbm),
            RER = se(RER),
            Total.Activity = se(Total.Activity),
            Lean.Mass = se(Lean.Mass),
            Fat.Mass = se(Fat.Mass),
            Percent.Fat.Mass = se(Percent.Fat.Mass),
            Body.Weight = se(Body.Weight)) %>%
  rename(Light.Dark=Light.Dark)
```

# Resting Metabolic Rate

The VO2 levels were first merged to average over light and dark cycles, removing the first `r remove.intervals` measurements.  To analyse these data we performed an ANCOVA analysis using lean body mass as the primary covariate. 

```{r VO2-by-lean}
superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
  arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
  length = length, ...)

par(mfrow=c(1,2))
plot.data <- subset(animal.summary,Light.Dark=='Dark')
with(plot.data, plot(Lean.Mass, VO2,pch=19, las=1, ylab="VO2", main='Dark', col=Treatment))
legend("bottomright", levels(merged_data$Treatment), pch=19, col=palette()[1:2], lty=1, bty='n')
#calculate best fit lines
dark.none.lm <- lm(VO2~Lean.Mass+Treatment, data=plot.data )
dark.none.hfd.aov <- aov(VO2~Lean.Mass+Treatment, data=plot.data )
#draw lines
abline(a=coefficients(dark.none.lm)[1],
       b=coefficients(dark.none.lm)[2], col=palette()[1])
abline(a=coefficients(dark.none.lm)[1]+coefficients(dark.none.lm)['TreatmentHigh Protein Diet'],
       b=coefficients(dark.none.lm)[2], col=palette()[2])


plot.data <- subset(animal.summary,Light.Dark=='Light')
with(plot.data, plot(Lean.Mass, VO2, pch=19, las=1, ylab="VO2", main='Light', col=Treatment))
legend("bottomright", levels(merged_data$Treatment), pch=19, col=palette()[1:2], lty=1, bty='n')
#calculate best fit lines
light.none.lm <- lm(VO2~Lean.Mass+Treatment, data=plot.data )
light.none.hfd.aov <- aov(VO2~Lean.Mass+Treatment, data=plot.data )
#draw lines
abline(a=coefficients(light.none.lm)[1],
       b=coefficients(light.none.lm)[2], col=palette()[1])
abline(a=coefficients(light.none.lm)[1]+coefficients(dark.none.lm)['TreatmentHigh Protein Diet'],
       b=coefficients(light.none.lm)[2], col=palette()[2])
```

```{r vo2-barplot}
vo2.dataset <- subset(grouped.summary, Light.Dark=='Dark') %>%
  group_by(Treatment) 
vo2.dataset.se <- subset(grouped.summary.se, Light.Dark=='Dark') %>%
  group_by(Treatment)

ymax = max(vo2.dataset$VO2.lbm, na.rm=T) + max(vo2.dataset.se$VO2.lbm, na.rm=T)
plot <- barplot(vo2.dataset$VO2.lbm, 
        beside=T, col=palette()[1:2], las=1,
        names.arg=vo2.dataset$Treatment,
        ylab="Oxygen Consumption (VO2/mL/h/g lean mass)", ylim=c(0,ymax))
superpose.eb(plot, vo2.dataset$VO2.lbm, vo2.dataset.se$VO2.lbm)

```

```{r vo2-diagnostic-plots}

library(lme4)
vo2.lme <- lmer(VO2 ~ Light.Dark + Lean + Treatment + (1|Subject), data=merged_data, REML=F)
vo2.lme.null <- lmer(VO2 ~ Light.Dark + Lean + (1|Subject), data=merged_data, REML=F)
library(influence.ME)
par(mfrow=c(1,3))
infl <- influence(vo2.lme, group='Subject')
barplot(cooks.distance(infl), main="Cook's Distance", 
        beside=T, col='grey',las=2, names.arg=rownames(cooks.distance(infl)))
plot(density(residuals(vo2.lme)), main="Residuals")
plot(fitted(vo2.lme), residuals(vo2.lme), xlab="Predicted VO2", ylab="Residuals", main="Residuals vs Predicted")
```

We first checked whether normality was maintained in the residuals from the ANCOVA.  These results are summarized below:

```{r vo2-ancova-summary, results='asis'}
#omnibus ANOVA
vo2.aov <-  aov(VO2~Lean.Mass+Light.Dark + Treatment, data=animal.summary)
vo2.lm <-  lm(VO2~Lean.Mass+Light.Dark + Treatment, data=animal.summary)
kable(summary(vo2.aov)[[1]], caption='ANCOVA Analysis for Effect of Diet on VO2')
library(car)
```

```{r vo2-time-course}
with(subset(animal.time.course, Treatment=="Control Diet"), plot(Interval,VO2, type="l", las=1, ylim=c(min(VO2), max(VO2))))
with(subset(animal.time.course, Treatment=="High Protein Diet"), lines(Interval,VO2, col=palette()[2]))
legend("topleft", levels(animal.time.course$Treatment), bty="n", lty=1, col=palette()[1:2])
```

The residuals of this model were normally distributed (p=`r shapiro.test(residuals(vo2.aov))$p.value`) via a Shapiro-Wilk Test.  According to this ANCOVA, the double knockouts have `r coef(vo2.aov)['TreatmentHigh Protein Diet']` higher VO2, a reduction of `r (predict(vo2.aov, newdata=list(Lean.Mass=30, Light.Dark='Dark',Treatment="High Protein Diet"))-predict(vo2.aov, newdata=list(Lean.Mass=30, Light.Dark='Dark',Treatment="Control Diet")))/predict(vo2.aov, newdata=list(Lean.Mass=30, Light.Dark='Dark',Treatment="Control Diet"))*100`%

Alternatively we used a mixed linear model, with non-interacting covariates for the Light cycle, the lean mass and the diet.  A Chi-squared test comparing a model with or without the Diet term yielded a p-value of `r  anova(vo2.lme,vo2.lme.null)$"Pr(>Chisq)"[2]` for the males.  The residuals of this model were **not normally distributed** (`r shapiro.test(residuals(vo2.lme))$p.value5` via Shapiro-Wilk Test).



# Body Weights and Composition

```{r body-composition-no-treatment}

par(mfrow=c(2,2))
library(tidyr)

bw.dataset <- subset(grouped.summary, Light.Dark=='Dark') %>%
  group_by(Treatment) 
bw.dataset.se <- subset(grouped.summary.se, Light.Dark=='Dark') %>%
  group_by(Treatment)

ymax = max(bw.dataset$Body.Weight, na.rm=T) + max(bw.dataset.se$Body.Weight, na.rm=T)
plot <- barplot(bw.dataset$Body.Weight, 
        beside=T, col=palette()[1:2], las=1,
        ylab="Weight (g)", ylim=c(0,ymax))
superpose.eb(plot, bw.dataset$Body.Weight, bw.dataset.se$Body.Weight)

ymax = max(bw.dataset$Lean.Mass, na.rm=T) + max(bw.dataset.se$Lean.Mass, na.rm=T)
plot <- barplot(bw.dataset$Lean.Mass, 
        beside=T, col=palette()[1:2], las=1,
        ylab="Lean Mass (g)", ylim=c(0,ymax))
superpose.eb(plot, bw.dataset$Lean.Mass, bw.dataset.se$Lean.Mass)

ymax = max(bw.dataset$Fat.Mass, na.rm=T) + max(bw.dataset.se$Fat.Mass, na.rm=T)
plot <- barplot(bw.dataset$Fat.Mass, 
        beside=T, col=palette()[1:2], las=1,
        ylab="Fat Mass (g)", ylim=c(0,ymax))
superpose.eb(plot, bw.dataset$Fat.Mass, bw.dataset.se$Fat.Mass)

ymax = max(bw.dataset$Percent.Fat.Mass, na.rm=T) + max(bw.dataset.se$Percent.Fat.Mass, na.rm=T)
plot <- barplot(bw.dataset$Percent.Fat.Mass, 
        beside=T, col=palette()[1:2], las=1,
        ylab="Percent Fat Mass", ylim=c(0,ymax))
superpose.eb(plot, bw.dataset$Percent.Fat.Mass, bw.dataset.se$Percent.Fat.Mass)
```

```{r body-weight-statistics}
comp.statistics <- subset(animal.summary, Light.Dark=='Dark') %>%
  select(Body.Weight, Lean.Mass, Fat.Mass, Percent.Fat.Mass) 

statistics.summary <- data.frame()
#for body weight
statistics.summary['Body Weight','Shapiro'] <- min(
  shapiro.test(subset(comp.statistics, Treatment=="Control Diet")$Body.Weight)$p.value,
  shapiro.test(subset(comp.statistics, Treatment=="High Protein Diet")$Body.Weight)$p.value)
statistics.summary['Body Weight', 'Levene'] <- leveneTest(Body.Weight~Treatment, data=comp.statistics)$"Pr(>F)"[1]
statistics.summary['Body Weight', 'Wilcox'] <- wilcox.test(Body.Weight~Treatment, data=comp.statistics)$p.value
statistics.summary['Body Weight', 'Welch'] <- t.test(Body.Weight~Treatment, data=comp.statistics, var.equal=F)$p.value
statistics.summary['Body Weight', 'Student'] <- t.test(Body.Weight~Treatment, data=comp.statistics, var.equal=T)$p.value
#for fat mass
statistics.summary['Fat Mass','Shapiro'] <- min(
  shapiro.test(subset(comp.statistics, Treatment=="Control Diet")$Fat.Mass)$p.value,
  shapiro.test(subset(comp.statistics, Treatment=="High Protein Diet")$Fat.Mass)$p.value)
statistics.summary['Fat Mass', 'Levene'] <- leveneTest(Fat.Mass~Treatment, data=comp.statistics)$"Pr(>F)"[1]
statistics.summary['Fat Mass', 'Wilcox'] <- wilcox.test(Fat.Mass~Treatment, data=comp.statistics)$p.value
statistics.summary['Fat Mass', 'Welch'] <- t.test(Fat.Mass~Treatment, data=comp.statistics, var.equal=F)$p.value
statistics.summary['Fat Mass', 'Student'] <- t.test(Fat.Mass~Treatment, data=comp.statistics, var.equal=T)$p.value
#for percent fat mass
statistics.summary['Percent Fat Mass','Shapiro'] <- min(
  shapiro.test(subset(comp.statistics, Treatment=="Control Diet")$Percent.Fat.Mass)$p.value,
  shapiro.test(subset(comp.statistics, Treatment=="High Protein Diet")$Percent.Fat.Mass)$p.value)
statistics.summary['Percent Fat Mass', 'Levene'] <- leveneTest(Percent.Fat.Mass~Treatment, data=comp.statistics)$"Pr(>F)"[1]
statistics.summary['Percent Fat Mass', 'Wilcox'] <- wilcox.test(Percent.Fat.Mass~Treatment, data=comp.statistics)$p.value
statistics.summary['Percent Fat Mass', 'Welch'] <- t.test(Percent.Fat.Mass~Treatment, data=comp.statistics, var.equal=F)$p.value
statistics.summary['Percent Fat Mass', 'Student'] <- t.test(Percent.Fat.Mass~Treatment, data=comp.statistics, var.equal=T)$p.value
#for lean mass
statistics.summary['Lean Mass','Shapiro'] <- min(
  shapiro.test(subset(comp.statistics, Treatment=="Control Diet")$Lean.Mass)$p.value,
  shapiro.test(subset(comp.statistics, Treatment=="High Protein Diet")$Lean.Mass)$p.value)
statistics.summary['Lean Mass', 'Levene'] <- leveneTest(Lean.Mass~Treatment, data=comp.statistics)$"Pr(>F)"[1]
statistics.summary['Lean Mass', 'Wilcox'] <- wilcox.test(Lean.Mass~Treatment, data=comp.statistics)$p.value
statistics.summary['Lean Mass', 'Welch'] <- t.test(Lean.Mass~Treatment, data=comp.statistics, var.equal=F)$p.value
statistics.summary['Lean Mass', 'Student'] <- t.test(Lean.Mass~Treatment, data=comp.statistics, var.equal=T)$p.value

kable(statistics.summary, caption="Statistical Tests for Body Composition")
```

# Respiratory Exchange Rate

```{r rer-barplot}
rer.dataset <- grouped.summary %>%
  group_by(Treatment, Light.Dark) %>%
  select(Light.Dark,Treatment,RER) %>%
  spread(Light.Dark, RER)
rer.dataset.se <- grouped.summary.se %>%
  group_by(Treatment, Light.Dark) %>%
  select(Light.Dark,Treatment,RER) %>%
  spread(Light.Dark, RER)

plot <- barplot(as.matrix(rer.dataset[2:3]), 
        beside=T, col=rer.dataset$Treatment, las=1,
        ylab="Respiratory Exchange Ratio", ylim=c(0.6,1),
        main="RER",xpd=FALSE)
axis(side=1,at=plot, labels=FALSE, tick=FALSE)
superpose.eb(plot, as.matrix(rer.dataset[2:3]), as.matrix(rer.dataset.se[2:3]))
legend("topright", levels(rer.dataset$Treatment), bty="n", fill=palette()[1:2])
```

```{r rer-time-course}
with(subset(animal.time.course, Treatment=="Control Diet"), plot(Interval,RER, type="l", las=1, ylim=c(0.6,1)))
with(subset(animal.time.course, Treatment=="High Protein Diet"), lines(Interval,RER, col=palette()[2]))
legend("bottomright", levels(rer.dataset$Treatment), bty="n", lty=1, col=palette()[1:2])
```

```{r rer-statistics-untreated}
rer.lme <- lmer(RER~Light.Dark + Treatment + (1|Subject), data=merged_data, REML=F)
rer.lme.null <- lmer(RER~Light.Dark + (1|Subject), data=merged_data, REML=F)

par(mfrow=c(1,3))
infl <- influence(rer.lme, group='Subject')
barplot(cooks.distance(infl), main="Cook's Distance", 
        beside=T, col='grey',las=2, names.arg=rownames(cooks.distance(infl)))
plot(density(residuals(rer.lme)), main="Residuals")
plot(fitted(rer.lme), residuals(rer.lme), xlab="Predicted RER", ylab="Residuals", main="Residuals vs Predicted")
```

Alternatively we used a mixed linear model, with non-interacting covariates for the Light cycle and the diet.  A Chi-squared test comparing a model with or without the diet term yielded a p-value of `r anova(rer.lme,rer.lme.null)$"Pr(>Chisq)"[2]` for the males.



# Activity Data

```{r activity}
activity.dataset <- grouped.summary %>%
  group_by(Treatment, Light.Dark) %>%
  select(Light.Dark,Treatment,Total.Activity) %>%
  spread(Light.Dark, Total.Activity)
activity.dataset.se <- grouped.summary.se %>%
  group_by(Treatment, Light.Dark) %>%
  select(Light.Dark,Treatment,Total.Activity) %>%
  spread(Light.Dark, Total.Activity)

ymax <- max(as.matrix(activity.dataset[2:3])) + max(as.matrix(activity.dataset.se[2:3]))
plot <- barplot(as.matrix(activity.dataset[2:3]), 
        beside=T, col=activity.dataset$Treatment, las=1,
        ylab="Ambulatory Movement", ylim=c(0,ymax),
        main="Activity")
superpose.eb(plot, as.matrix(activity.dataset[2:3]), as.matrix(activity.dataset.se[2:3]))
legend("topright", levels(activity.dataset$Treatment), bty="n", fill=palette()[1:2])
```

```{r activity-statistics}
activity.lme <- glmer(Total.Activity~Light.Dark + Treatment + (1|Subject), data=merged_data, family='poisson', REML=F)
activity.lme.null <- glmer(Total.Activity~Light.Dark + (1|Subject), data=merged_data, family='poisson', REML=F)

par(mfrow=c(1,3))
infl <- influence(activity.lme, group='Subject')
barplot(cooks.distance(infl), main="Cook's Distance", 
        beside=T, col='grey',las=2, names.arg=rownames(cooks.distance(infl)))
plot(density(residuals(activity.lme)), main="Residuals")
plot(fitted(activity.lme), residuals(activity.lme), xlab="Predicted Activity", ylab="Residuals", main="Residuals vs Predicted")
```

Alternatively we used a mixed linear model, with non-interacting covariates for the Light cycle and the diet.  A Chi-squared test comparing a model with or without the Genotype term yielded a p-value of `r anova(activity.lme,activity.lme.null)$"Pr(>Chisq)"[2]` for the males.

# Session Information

```{r session-info, echo=FALSE, message=FALSE}
sessionInfo()
```
