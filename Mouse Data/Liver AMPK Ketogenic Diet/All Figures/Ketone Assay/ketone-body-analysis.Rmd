---
title: "Ketone body analyses for AMPK and Raptor Knockout Studies"
author: "Katherine Kistler and Dave Bridges"
date: "July 18, 2019"
output:
  html_document:
    highlight: tango
    keep_md: yes
    number_sections: yes
    toc: yes
  pdf_document:
    highlight: tango
    keep_tex: yes
    number_sections: yes
    toc: yes
---

```{r global_options, include=FALSE}
library(knitr)
#figures makde will go to directory called figures, will make them as both png and pdf files 
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(scipen = 2, digits = 3)
# set echo and message to TRUE if you want to display code blocks and code output respectively

knitr::knit_hooks$set(inline = function(x) {
  knitr:::format_sci(x, 'md')
})


superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
  arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
  length = length, ...)

  
se <- function(x) sd(x, na.rm=T)/sqrt(length(x))

#load these packages, nearly always needed
library(tidyr)
library(dplyr)

# sets maize and blue color scheme
color.scheme <- c('#00274c', '#ffcb05')
```

# Purpose

# Experimental Details

Link to the protocol used (permalink preferred) for the experiment and include any notes relevant to your analysis.  This might include specifics not in the general protocol such as cell lines, treatment doses etc.

# Raw Data

Describe your raw data files, including what the columns mean (and what units they are in).

```{r data-input}
library(readxl) #loads the readr package
filename <- '2019-07-18 BHB Assay.xlsx' #make this a separate line, you can use any variable you want

#this loads whatever the file is into a dataframe called exp.data if it exists
exp.data <- read_excel(filename, sheet = "Sheet1")

#from western blot data
not.ko <- c(8830,8284,8715,8716,8717,8718,8719,8786)

exclude.mice <- c('8078','8349','8830','8284','8715','8716','8717','8718','8719','8786') #excluded 8349 which had an error in ketone determination (<<<0)
library(forcats)
exp.data <- 
  exp.data %>%
  filter(!(Mouse %in% exclude.mice)) %>%
  filter(!(is.na(Genotype ))) %>%
  mutate(Injection = fct_recode(Injection, "AAV-Tbg-Cre" = "CRE",
                                "AAV-Tbg-GFP"="GFP")) %>%
    mutate(Injection = relevel(as.factor(Injection), ref="AAV-Tbg-Cre")) %>%
    mutate(Injection = ifelse(Mouse %in% not.ko, "AAV-Tbg-GFP", as.character(Injection)))  #modified genotypes based on western blotting
  
  
```

These data can be found in **`r getwd()`** in a file named **`r ifelse(filename %in% dir(), filename, "no file found")`**.  This script was most recently updated on **`r date()`**.

# Analysis

```{r count}
exp.data %>%
  group_by(Week,Sex,Diet,Injection) %>%
  distinct(Mouse, .keep_all = T) %>%
  count %>%
  kable(caption="Animals in each group of this cohort")
```

## Boxplots

```{r boxplot-1-week, fig.cap="Ketone levels after one week of diet"}
library(ggplot2)
ggplot(data=exp.data %>% filter(Week==1),
       aes(y=`Final Conc`,
           x=Diet,
           fill=Injection)) +
  geom_boxplot() +
  geom_point(position=position_dodge(width=0.75),aes(group=Injection)) +
  facet_grid(Sex~Genotype)+
  expand_limits(y=0) +
  labs(title="Ketone Levels",
       subtitle="After 1 week",
       y="Ketone Bodies (mM)")

library(ggplot2)
ggplot(data=exp.data %>% filter(Week==4),
       aes(y=`Final Conc`,
           x=Diet,
           fill=Injection)) +
  geom_boxplot() +
  geom_point(position=position_dodge(width=0.75),aes(group=Injection)) +
  facet_grid(Sex~Genotype)+
  expand_limits(y=0) +
  labs(title="Ketone Levels",
       subtitle="After 4 week",
       y="Ketone Bodies (mM)")
```

```{r boxplot-4-weeks-ampk, fig.cap="Ketone levels after four weeks of diet"}
ggplot(data=exp.data %>% filter(Week==4, Genotype =="AMPK", Sex=='Male'), 
       aes(y=`Final Conc`,
           x=Diet,
           fill=Injection)) +
  geom_boxplot() +
  geom_point(position=position_dodge(width=0.75),aes(group=Injection)) +
  expand_limits(y=0) +
  labs(title="Ketone Levels",
       subtitle="After 4 weeks",
       y="Ketone Bodies (mM)")
```


## Barplots

```{r barplot-1-week, fig.cap="Ketone levels after one week of diet"}
exp.data %>%
  filter(Week ==1, Genotype == "Raptor" ) %>%
  group_by(Sex, Genotype, Injection, Diet) %>%
  summarize(Mean = mean(`Final Conc`),
            Error = se(`Final Conc`)) %>%
  ggplot(aes(y=Mean,
           ymin=Mean-Error,
           ymax=Mean+Error,
           x=Diet,
           fill=Injection,
           col=Injection)) +
  geom_bar(stat="identity", position='dodge') +
  geom_errorbar(position=position_dodge(width=0.75),aes(group=Injection), width=0.5) +
  facet_grid(Sex~Genotype) +
  expand_limits(y=0) +
  labs(title="Ketone Levels",
       subtitle="After 1 week",
       y="Ketone Bodies (mM)")
```

```{r barplot-4-weeks, fig.cap="Ketone levels after four weeks of diet"}
exp.data %>%
  filter(Week == 4, Genotype == "Raptor") %>%
  group_by(Sex, Genotype, Injection, Diet) %>%
  summarize(Mean = mean(`Final Conc`),
            Error = se(`Final Conc`)) %>%
  ggplot(aes(y=Mean,
           ymin=Mean-Error,
           ymax=Mean+Error,
           x=Diet,
           fill=Injection)) +
  geom_bar(stat='identity', position='dodge', width=0.75) +
  geom_errorbar(position=position_dodge(width=0.75),aes(group=Injection), width=0.5) +
    facet_grid(Sex~Genotype)+
  expand_limits(y=0) +
  labs(title="Ketone Levels",
       subtitle="After 4 weeks",
       y="Ketone Bodies (mM)")

#Statistics

library(broom)

aov(`Final Conc` ~ Sex + Diet + Injection + Diet:Injection, data=exp.data%>%filter(Genotype =="Raptor")) %>% tidy %>% kable(caption="Effects of diet/sex on  ketone levels in Rptor liver knockouts.  Includes interaction between diet and genotype")
aov(`Final Conc` ~ Sex + Diet + Injection, data=exp.data%>%filter(Genotype =="Raptor")) %>% tidy %>% kable(caption="Effects of diet/sex on  ketone levels in Rptor liver knockouts.  No interaction between diet and genotype")

aov(`Final Conc` ~ Sex + Diet + Injection + Diet:Injection, data=exp.data%>%filter(Genotype =="AMPK")) %>% tidy %>% kable(caption="Effects of diet/sex on  ketone levels in AMPK liver knockouts.  Includes interaction between diet and genotype")
aov(`Final Conc` ~ Sex + Diet + Injection, data=exp.data%>%filter(Genotype =="AMPK")) %>% tidy %>% kable(caption="Effects of diet/sex on  ketone levels in AMPK liver knockouts.  No interaction between diet and genotype")

```

```{r barplot-4-week-ampk, fig.cap="Ketone levels after four weeks of diet for AMPK knockouts"}
exp.data %>%
  filter(Week == 4, Genotype=="AMPK", Sex=="Male" ) %>%
  mutate(Injection = relevel(as.factor(Injection), ref="AAV-Tbg-GFP")) %>%
  group_by(Sex, Genotype, Injection, Diet) %>%
  summarize(Mean = mean(`Final Conc`),
            Error = se(`Final Conc`)) %>%
  ggplot(aes(y=Mean,
           ymin=Mean-Error,
           ymax=Mean+Error,
           x=Diet,
           fill=Injection)) +
  geom_bar(stat='identity', position='dodge', width=0.75) +
  geom_errorbar(position=position_dodge(width=0.75),aes(group=Injection), width=0.5) +
  expand_limits(y=0) +
  labs(title="Ketone Levels",
       subtitle="After 4 weeks of diet",
       y="Ketone Bodies (mM)") +
  theme_classic() +
  theme(text=element_text(size=18),
        legend.position = c(0.2,0.8))

exp.data %>%
  filter(Week == 4, Genotype=="AMPK", Sex=="Male" ) %>%
  mutate(Injection = relevel(as.factor(Injection), ref="AAV-Tbg-GFP")) %>%
  group_by(Sex, Genotype, Injection, Diet) %>%
  summarize(Mean = mean(`Final Conc`),
            Error = se(`Final Conc`)) %>%
  kable(caption="Summary of average ketone levels")
```

# Interpretation

A brief summary of what the interpretation of these results were

# Session Information

```{r session-information, echo=T}
sessionInfo()
```

