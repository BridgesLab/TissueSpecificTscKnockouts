---
title: "Ketone Tolerance in CD/KD A/J Mice"
author: "Cody Cousineau, Detrick Snyder and Dave Bridges"
date: "August 8, 2019"
output:
  html_document:
    toc: yes
    keep_md: yes
  pdf_document:
    highlight: tango
    keep_tex: yes
    number_sections: no
    toc: yes
---

```{r setup, include=FALSE}
library(knitr)
#figures makde will go to directory called figures, will make them as both png and pdf files 
opts_chunk$set(fig.path='figures/',
               echo=TRUE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(scipen = 2, digits = 3)
# set echo and message to TRUE if you want to display code blocks and code output respectively

knitr::knit_hooks$set(inline = function(x) {
  knitr:::format_sci(x, 'md')
})


superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
  arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
  length = length, ...)

  
se <- function(x) sd(x, na.rm=T)/sqrt(length(x))

#load these packages, nearly always needed
library(tidyr)
library(dplyr)

# sets maize and blue color scheme
color.scheme <- c('#00274c', '#ffcb05')
```

This script was most recently run on `r date()` and can be found in `r getwd()`.

# Purpose


# Experimental Details

Beta hydroxybutyrate was injected at 1g/kg into fed mice around 14:00 PM, ketone levels were assessed via tail vein injection using strips.

# Raw Data


```{r data-entry}
library(readr)

raw_data_file <- "AJ Ketone Tolerance Data.csv"
kd.mouseids <- scan('KD Mouse IDs.txt')
library(readr) 
measurement.data <- read_csv(raw_data_file)

library(lubridate)
measurement.data$parsed.experiment.date <- ymd(measurement.data$experiment.date)

genotype.problems <- c() #animals where we are unsure about the genotype/treatment

ketone.data <- 
  filter(measurement.data, assay=='Plasma Glucose') %>%
  mutate(Diet = as.factor(if_else(animal.id %in% kd.mouseids, "Ketogenic Diet", "Control Diet"))) %>% 
  separate(values, sep=',', into=paste0("t",seq(0,120, by=15))) %>%
  select(age,Genotype,t0:t120,Diet,animal.id,MouseID) %>%
  mutate(ITT = if_else(is.na(t15), "No","Yes")) %>%
  mutate(FK = as.numeric(t0)/10) %>%
  mutate_at(.vars=3:11, .funs=funs(as.numeric(.)/10))

ketone.data <- 
  ketone.data %>% 
  mutate(AUC = rowSums(across(t0:t90)),
         AOC = rowSums(across(t0:t90))-(t0*7))

ketone.data.norm <-
  ketone.data %>%
  filter(ITT=="Yes") %>%
  filter(!(MouseID %in% genotype.problems)) %>% #removed animals with incorrect genotype
  mutate(t15=t15/t0*100,
         t30=t30/t0*100,
         t45=t45/t0*100,
         t60=t60/t0*100,
         t75=t75/t0*100,
         t90=t90/t0*100,
         t105=t105/t0*100,
         t120=t120/t0*100,
         t0=t0/t0*100) 

ketone.data.norm.abs <-
  ketone.data %>%
  filter(ITT=="Yes") %>%
  filter(!(MouseID %in% genotype.problems)) %>% #removed animals with incorrect genotype
  mutate(t15=t15-t0,
         t30=t30-t0,
         t45=t45-t0,
         t60=t60-t0,
         t75=t75-t0,
         t90=t90-t0,
         t105=t105-t0,
         t120=t120-t0,
         t0=t0-t0) 

ketone.data.norm.pk <-
  ketone.data %>%
  filter(ITT=="Yes") %>%
  filter(!(MouseID %in% genotype.problems)) %>% #removed animals with incorrect genotype
  mutate(t0=t0/t15*100,
         t30=t30/t15*100,
         t45=t45/t15*100,
         t60=t60/t15*100,
         t75=t75/t15*100,
         t90=t90/t15*100,
         t105=t105/t15*100,
         t120=t120/t15*100,
         t15=t15/t15*100) 



kable(ketone.data %>% 
        filter(ITT=="Yes") %>% 
        select(MouseID, Diet, FK,age) %>%
        arrange(age,MouseID, Diet),caption="Animals who underwent an KTT")

ketone.data %>%
  filter(ITT=="Yes") %>% 
  group_by(Diet,age) %>%
  count %>%
  kable(caption="Animals evaluated by KTT in each group")
```



# Analysis

```{r ketone.summary}
ketone.summary <-
  ketone.data %>%
  group_by(Diet,age) %>%
  summarize(FK.mean = mean(FK, na.rm=T),
            FK.se = se(FK),
            N = length(FK))
```

## Fed Ketone Levels

```{r fasting-ketone-boxplot-itt, fig.cap="Fed ketones, by treatment"}
library(ggplot2)
ggplot(filter(ketone.data, ITT=="Yes"),
            aes(y=FK, x=Diet)) +
  geom_boxplot() +
  facet_grid(.~age) +
  labs(title="Fed Ketones",
       y="Ketones (mg/dL)",
       x="Diet")
```


```{r fasting-ketone-barplot-itt-ko, fig.cap="Fed ketones"}
ggplot(ketone.summary,
       aes(y=FK.mean,
           ymin = FK.mean - FK.se,
           ymax = FK.mean + FK.se,
           x = Diet)) +
  facet_grid(.~age) +
  geom_bar(stat='identity', position='dodge', width=0.75) +
  geom_errorbar(position=position_dodge(width=0.75), width=0.5) +
  labs(y='Fed Blood Ketones (mg/dL)',
       x='')
```

### Fed ketone Statistics

```{r fk-stats}
library(broom)

ketone.data %>% 
  filter(age=='92') %>%
  group_by(Diet) %>%
  summarize_at(.vars='t0',.funs=list(mean=~mean(.),
                             se=~se(.),
                             sd=~sd(.),
                             n=~length(.),
                             shapiro=~shapiro.test(.)$p.value)) %>%
  mutate(Pct.change=(mean-mean[Diet=='Control Diet'])/mean[Diet=='Control Diet']*100) -> fed.ketone.summary
  
kable(fed.ketone.summary, caption="Summary statistics for fed ketone levels")

wilcox.test(t0~Diet,data=ketone.data %>% 
  filter(age=='92')) %>% 
  tidy %>%
  kable(caption="Mann Whitney test for modifying effects of effects of diet on fed ketones at 3 weeks")

fk.aov <- aov(FK~Diet*age, data=ketone.data)
tidy(fk.aov) %>% kable(caption="ANOVA for modifying effects of effects of fed ketones")
```

## Ketone Tolerance Test

```{r ktt-dotplot, fig.cap="Ketone tolerance tests by treatments"}
time <- seq(0,120,by=15)
ktt.data.long <- 
  ketone.data %>%
  filter(ITT=="Yes") %>%
  group_by(Diet,animal.id) %>%
  gather(`t0`:`t120`,key='TimeStamp', value="ketone") %>%
  separate(TimeStamp, sep="t", into=c("Letter","Time")) %>%
  mutate(ketone = as.numeric(ketone)) %>%
  mutate(Time = as.numeric(Time))

ktt.data.long.norm <- 
  ketone.data.norm %>%
  filter(ITT=="Yes") %>%
  group_by(animal.id,Diet) %>%
  gather(`t0`:`t120`,key='TimeStamp', value="ketone") %>%
  separate(TimeStamp, sep="t", into=c("Letter","Time")) %>%
  mutate(ketone = as.numeric(ketone)) %>%
  mutate(Time = as.numeric(Time))

ktt.data.long.norm.pk <- 
  ketone.data.norm.pk %>%
  filter(ITT=="Yes") %>%
  group_by(animal.id,Diet) %>%
  gather(`t0`:`t120`,key='TimeStamp', value="ketone") %>%
  separate(TimeStamp, sep="t", into=c("Letter","Time")) %>%
  mutate(ketone = as.numeric(ketone)) %>%
  mutate(Time = as.numeric(Time))

ktt.data.long.norm.abs <- 
  ketone.data.norm.abs %>%
  filter(ITT=="Yes") %>%
  group_by(animal.id,Diet) %>%
  gather(`t0`:`t120`,key='TimeStamp', value="ketone") %>%
  separate(TimeStamp, sep="t", into=c("Letter","Time")) %>%
  mutate(ketone = as.numeric(ketone)) %>%
  mutate(Time = as.numeric(Time))

ggplot(ktt.data.long,
            aes(y=ketone, x=Time, col=Diet)) +
  geom_point() +
  facet_grid(.~age) +
  geom_smooth(method="loess") +
  labs(title="Ketone Tolerance Test",
       subtitle="4 Days of KD",
       y="Blood Ketones (mg/dL)") 

ggplot(ktt.data.long,
            aes(y=ketone, x=Time, col=Diet)) +
  geom_point() +
  geom_smooth(method="loess") +
  labs(title="BHB Tolerance Test",
       y="Blood Ketones (mg/dL)") 

ggplot(ktt.data.long.norm,
            aes(y=ketone, x=Time, col=Diet)) +
  geom_point() +
  facet_grid(.~age) +
  geom_smooth(method="loess") +
  labs(title="Ketone Tolerance Test",
       subtitle="4 Days of KD",
       y="Blood Ketones (% of Initial)") 

ggplot(ktt.data.long.norm.pk,
            aes(y=ketone, x=Time, col=Diet)) +
  geom_point() +
  facet_grid(.~age) +
  geom_smooth(method="loess") +
  labs(title="Ketone Tolerance Test",
       subtitle="4 Days of KD",
       y="Blood Ketones (% of Peak)") 
```

```{r ktt-lineplot}
ktt.data.long %>%
  group_by(Time,Diet,age) %>%
  summarize(Average = mean(ketone),
            Error = se(ketone)) %>%
ggplot(aes(y=Average,
           ymax=Average+Error,
           ymin=Average-Error,
           x=Time, col=Diet)) +
  geom_point() +
  geom_line() +
  facet_grid(.~age) +
  geom_errorbar() +
  labs(title="BHB Tolerance Test",
       subtitle="4 Days of KD",
       y="Blood Ketones (mg/dL)") 

ktt.data.long %>%
  group_by(Time,Diet,age) %>%
  summarize(Average = mean(ketone),
            Error = se(ketone)) %>%
  filter(age=='92'&Time<100) %>%
ggplot(aes(y=Average,
           ymax=Average+Error,
           ymin=Average-Error,
           x=Time, lty=Diet)) +
  geom_point() +
  geom_line() +
  geom_errorbar() +
  labs(title="BHB Tolerance Test",
       y="Blood Ketone Bodies (mg/dL)") +
  theme_classic() +
  theme(text=element_text(size=16),
        legend.position=c(0.9,0.8))

ktt.data.long.norm.abs %>%
  group_by(Time,Diet,age) %>%
  summarize(Average = mean(ketone),
            Error = se(ketone)) %>%
  filter(age=='92'&Time<100) %>%
ggplot(aes(y=Average,
           ymax=Average+Error,
           ymin=Average-Error,
           x=Time, lty=Diet)) +
  geom_point() +
  geom_line() +
  geom_errorbar() +
  labs(title="BHB Tolerance Test - Baseline Subtracted",
       y="Blood Ketone Bodies (mg/dL)") +
  theme_classic() +
  theme(text=element_text(size=16),
        legend.position=c(0.9,0.8))
```

## Area Under the Curve

```{r ktt-auc}
ketone.data %>%
  group_by(Diet,age) %>%
  summarize(mean=mean(AUC),
            se=se(AUC)) -> ktt.auc.summary

ktt.auc.summary %>%
  ggplot(aes(y=mean,
             ymin=mean-se,
             ymax=mean+se,
             x=Diet)) +
  geom_bar(stat='identity') +
  geom_errorbar(width=0.5) +
  facet_grid(~age) +
  labs(y="Area Under the Curve")
```

## Normalized Area Under the Curve

```{r ktt-auc-norm}
ketone.data %>%
  group_by(Diet,age) %>%
  summarize(mean=mean(AOC),
            se=se(AOC)) -> ktt.auc.summary

ktt.auc.summary %>%
  ggplot(aes(y=mean,
             ymin=mean-se,
             ymax=mean+se,
             x=Diet)) +
  geom_bar(stat='identity') +
  geom_errorbar(width=0.5) +
  facet_grid(~age) +
  labs(y="Area Under the Curve (Baseline Subtracted)")

ktt.auc.summary %>%
  filter(age=='92') %>%
  ggplot(aes(y=mean,
             ymin=mean-se,
             ymax=mean+se,
             x=Diet)) +
  geom_bar(stat='identity') +
  geom_errorbar(width=0.5) +
  labs(title="BHB Tolerance Test", 
       subtitle="Baseline Subtracted",
       x="",
       y="Area Under the Curve") +
  theme_classic()+
  theme(text=element_text(size=16))
```

### Stats for Normalized Area Under the Curve

```{r ktt-auc-norm-stats}
ketone.data %>% 
  filter(age=='92') %>%
  group_by(Diet) %>%
  summarize_at(.vars='AOC',.funs=list(mean=~mean(.),
                             se=~se(.),
                             sd=~sd(.),
                             n=~length(.),
                             shapiro=~shapiro.test(.)$p.value)) %>%
  mutate(Pct.change=(mean-mean[Diet=='Control Diet'])/mean[Diet=='Control Diet']*100) -> fed.ketone.summary
  
kable(fed.ketone.summary, caption="Summary statistics for fed ketone levels")

library(car)
leveneTest(AOC~Diet,data=ketone.data %>% 
  filter(age=='92')) %>% 
  tidy %>%
  kable(caption="Levene's test for modifying effects of effects of diet on the baseline subtracted area over the curve")

t.test(AOC~Diet,data=ketone.data %>% 
  filter(age=='92'),
  var.equal=T) %>% 
  tidy %>%
  kable(caption="Student's t test for modifying effects of effects of diet on the baseline subtracted area over the curve")

t.test(AOC~Diet,data=ketone.data %>% 
  filter(age=='92'),
  var.equal=T,
  alternative="less") %>% 
  tidy %>%
  kable(caption="Student's t test for modifying effects of effects of diet on the baseline subtracted area over the curve")
```


## Normalized to fasting ketone levels (percent change)

```{r normalized-ktt}
ktt.data.long.norm %>%
  filter(!(animal.id %in% c('23224','23225'))) %>%
  group_by(Time,Diet,age) %>%
  summarize(Average = mean(ketone),
            Error = se(ketone)) %>%
ggplot(aes(y=Average,
           ymax=Average+Error,
           ymin=Average-Error,
           x=Time, col=Diet)) +
  geom_point() +
  geom_line() +
  facet_grid(.~age) +
  geom_errorbar() +
  labs(title="Ketone Tolerance Test",
       subtitle="4 Days of KD",
       y="Blood Ketones (% of initial)") 

ktt.data.long.norm %>%
  filter(!(animal.id %in% c('23224','23225'))) %>%
  filter(age == '92') %>%
  group_by(Time,Diet,age) %>%
  summarize(Average = mean(ketone),
            Error = se(ketone)) %>%
ggplot(aes(y=Average,
           ymax=Average+Error,
           ymin=Average-Error,
           x=Time, col=Diet)) +
  geom_point() +
  geom_line() +
  geom_errorbar() +
  scale_color_manual(values=color.scheme, labels=c('Control Diet','LCHF Diet'), name="") +
  labs(title="Ketone Tolerance Test",
       subtitle="3 Weeks of LCHF",
       y="Blood Ketones (% of Basal)") +
  xlim(0,95) +
  theme_classic() +
  theme(text = element_text(size=18),
        legend.position = c(0.75,0.75))
  
```


## Normalized to fasting ketone levels (absolute change)

```{r normalized-ktt-abs}
ktt.data.long.norm.abs %>%
  filter(!(animal.id %in% c('23224','23225'))) %>%
  group_by(Time,Diet,age) %>%
  summarize(Average = mean(ketone),
            Error = se(ketone)) %>%
ggplot(aes(y=Average,
           ymax=Average+Error,
           ymin=Average-Error,
           x=Time, col=Diet)) +
  geom_point() +
  geom_line() +
  facet_grid(.~age) +
  geom_errorbar() +
  labs(title="Ketone Tolerance Test",
       subtitle="4 Days of KD",
       y="Blood Ketones (% of initial)") 

ktt.data.long.norm.abs %>%
  filter(!(animal.id %in% c('23224','23225'))) %>%
  filter(age == '92') %>%
  group_by(Time,Diet,age) %>%
  summarize(Average = mean(ketone),
            Error = se(ketone)) %>%
ggplot(aes(y=Average,
           ymax=Average+Error,
           ymin=Average-Error,
           x=Time, col=Diet)) +
  geom_point() +
  geom_line() +
  geom_errorbar() +
  scale_color_manual(values=color.scheme, labels=c('Control Diet','LCHF Diet'), name="") +
  labs(title="Ketone Tolerance Test",
       subtitle="3 Weeks of LCHF",
       y="Blood Ketones (Above Basal)") +
  xlim(0,95) +
  theme_classic() +
  theme(text = element_text(size=18),
        legend.position = c(0.75,0.75))
  
```


## Normlized to the Peak of Ketone levels

```{r ktt-peak}
ktt.data.long.norm.pk %>%
  group_by(Time,Diet,age) %>%
  summarize(Average = mean(ketone),
            Error = se(ketone)) %>%
ggplot(aes(y=Average,
           ymax=Average+Error,
           ymin=Average-Error,
           x=Time, col=Diet)) +
  geom_point() +
  geom_line() +
  facet_grid(.~age) +
  geom_errorbar() +
  labs(title="Ketone Tolerance Test",
       subtitle="4 Days and 3 Weeks of KD",
       y="Blood Ketones (% of Peak)") 
```

## KTT Statistics



### Linear Models

```{r ktt-stats}

library(lme4)
library(lmerTest)
ktt.lme <- lmer(ketone ~ as.factor(Time) + as.factor(age) + Diet + age:Diet + (1|animal.id),
                data=ktt.data.long)

ktt.lme.92d.null <- lmer(ketone ~ as.factor(Time) + (1|animal.id),
                data=ktt.data.long %>% filter (age==92))

ktt.lme.92d <- lmer(ketone ~ as.factor(Time) + Diet + (1|animal.id),
                data=ktt.data.long %>% filter (age==92))

ktt.lme.92d.norm <- lmer(ketone ~ as.factor(Time) + Diet + (1|animal.id),
                data=ktt.data.long.norm.abs %>% filter (age==92))

ktt.lme.92d.norm.null <- lmer(ketone ~ as.factor(Time) + (1|animal.id),
                data=ktt.data.long.norm.abs %>% filter (age==92))

anova(ktt.lme.92d) %>% tidy %>% kable(caption="Mixed linear model for KTT at 3 weeks")
summary(ktt.lme.92d)
anova(ktt.lme.92d,ktt.lme.92d.null) %>% tidy %>% kable(caption="Chi squared test for non-adjusted KTT")

anova(ktt.lme.92d.norm) %>% tidy %>% kable(caption="Mixed linear model for baseline adjusted KTT at 3 weeks")
summary(ktt.lme.92d.norm)
anova(ktt.lme.92d.norm,ktt.lme.92d.norm.null) %>% tidy %>% kable(caption="Chi squared test for baseline adjusted KTT")

```

# Session Information

```{r session-info}
sessionInfo()
```

