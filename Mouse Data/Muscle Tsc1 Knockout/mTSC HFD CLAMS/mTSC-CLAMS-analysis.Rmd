---
title: "Analysis of mTSC1 Knockout CLAMS Experiments"
author: "Erin Stephenson and Dave Bridges"
date: "January 31, 2019"
output:
  html_document:
    highlight: tango
    keep_md: yes
    number_sections: no
    toc: yes
  pdf_document:
    highlight: tango
    keep_tex: yes
    number_sections: yes
    toc: yes
---

```{r global_options, include=FALSE}
library(knitr)
#figures makde will go to directory called figures, will make them as both png and pdf files 
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(scipen = 2, digits = 3)
# set echo and message to TRUE if you want to display code blocks and code output respectively

knitr::knit_hooks$set(inline = function(x) {
  knitr:::format_sci(x, 'md')
})


superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
  arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
  length = length, ...)

  
se <- function(x) sd(x, na.rm=T)/sqrt(length(x))

#load these packages, nearly always needed
library(tidyr)
library(dplyr)

# sets maize and blue color scheme
color.scheme <- c('#00274c', '#ffcb05')
```

# Purpose

To evaluate energy expenditure and other parameters in muscle _Tsc1_ knockout mice.  This script was most recently updated on **`r date()`**.

# Experimental Details

Mice were run in the CLAMS in several batches, and combined.

# Raw Data

## Sample Key

```{r data-input}
library(readxl) #loads the readr package
key.filename <- 'mTSC-HFD_CLAMS_Experiment_Key.xlsx' #make this a separate line, you can use any variable you want
key.data <- read_excel(key.filename, sheet = 'Sheet1') %>%
  mutate(Knockout = if_else(Genotype=='fl/fl; Tg/+', 'Knockout','Control'))
```

## Oxymax Input

There are two batches of data, baseline and after 3 months of diet.

### Baseline Data

```{r baseline-data-input}
baseline.folder <- "Oxymax/Oxymax files by time period/Baseline"
baseline.files <- list.files(path=baseline.folder, pattern="*.csv", full.names=T)

mri.folder <- "EchoMRI"
mri.files <- list.files(path=mri.folder, pattern="*.xlsx", full.names=T)

library(readr)
library(lubridate)
library(readxl)

mri.data <- read_excel(mri.files[1]) %>% mutate(Label = as.factor(Label))
for (file in mri.files[2:length(mri.files)]) {
  mri.data <- bind_rows(mri.data, read_excel(file) %>% mutate(Label = as.factor(Label)))
}

#remove repeated mri measurements
mri.data.unique <-
  mri.data %>%
  distinct(Label, .keep_all = T) %>%
  select(Label,Fat,Lean,Weight)

baseline.data <-  
  lapply(baseline.files, read_csv) %>% 
  bind_rows() %>%
  select(Subject, Interval, `Date/Time`, `Light/Dark`, `Volume O2`, RER, `X Ambulatory`, `Y Ambulatory`,`Volume CO2`,Heat) %>%
  right_join(key.data, by=c('Subject'='Mouse'))  %>% #merged with annotation file
  mutate(Date.Time = mdy_hms(`Date/Time`)) %>% #parsed datetime
  mutate(Time = hour(Date.Time)) %>% #extracted the hour 
  mutate(Zeitgeber.Time = Time-7) %>% # converted to ZT
  mutate(Activity = `X Ambulatory` + `Y Ambulatory`) %>%
  mutate(Subject = as.factor(Subject)) %>%
  rename(Heat.kw = Heat) %>% #heat is originally in Kcal/h
  mutate(Heat = Heat.kw*1.163) %>% #heat is in kCal/h originally, converted to Watts)
  full_join(mri.data.unique, by=c('Subject'='Label')) #merged in mri data

baseline.data %>%
  group_by(Genotype,Sex) %>%
  distinct(Subject,.keep_all=T) %>%
  count %>%
  kable(caption="Total animals tested by genotype")

baseline.data %>%
  group_by(Knockout,Sex) %>%
  distinct(Subject,.keep_all=T) %>%
  count %>%
  kable(caption="Total animals tested by knockout")


#wrote out the census data, showing one line for each animals
baseline.data %>%
  distinct(Subject,Sex,Genotype, .keep_all = T) %>%
  select(Subject,Sex,Genotype,Date.Time,Lean,Fat,`Volume O2`) %>%
  arrange(-Lean) %>%
  write_csv("Baseline Data.csv")

```

The baseline raw data files can be found in `r baseline.folder`.  The MRI data can be found in `r mri.folder`.

## VO2 Analysis

```{r vo2-analysis-light-dark, fig.cap="VO2 Summary Light/Dark Boxplot"}
animal.data.ld <-
  baseline.data %>%
  filter(Interval>100) %>% #removed first 20 intervals
  filter(RER>0.5) %>%
  filter(RER<1.2) %>% #removed biologically implausible values
    filter(Subject!='4762') %>% #removed outlier sample
  group_by(Subject,Genotype,Knockout,Sex, `Light/Dark`) %>% #calculated average hour/animal level data
  summarize(RER = mean(RER,na.rm=T),
            VO2 = mean(`Volume O2`,na.rm=T),
            VCO2 = mean(`Volume CO2`),
            Activity = mean(Activity, na.rm=T),
            Heat = mean(Heat,na.rm=T)) 

animal.data.ld.summary <-
  animal.data.ld %>%
  group_by(Knockout,Sex,`Light/Dark`) %>%
  summarize_if(is.numeric, .funs=funs(mean,se))

library(ggplot2)

ggplot(animal.data.ld.summary,
       aes(y=VO2_mean,
           ymin=VO2_mean-VO2_se,
           ymax=VO2_mean+VO2_se,
           x=`Light/Dark`,
           fill=`Knockout`)) +
  geom_bar(stat='identity', position='dodge', width=0.75) +
  geom_errorbar(position=position_dodge(width=0.75),aes(group=Knockout), width=0.5) +
  labs(y="Oxygen Consumption (mL/h)",
       x="Time") +
  facet_grid(~Sex)


library(ggplot2)

ggplot(animal.data.ld,
       aes(y=VO2,x=`Light/Dark`,
           col=Knockout)) +
  geom_boxplot(width=0.75) +
  geom_jitter(position=position_dodge(width=0.75)) +
  facet_grid(~Sex)
```

```{r vo2-analysis-linegraph, fig,cap="Mouse level VO2 levels"}
animal.data <-
  baseline.data %>%
  filter(Interval>100) %>% #removed first 100 intervals
  filter(RER>0.5) %>%
  filter(RER<1.2) %>% #removed biologically implausible values
  filter(Subject!='4762') %>% #removed outlier sample
  group_by(Subject,Genotype,Knockout,Sex, Zeitgeber.Time) %>% #calculated average hour/animal level data
  summarize(RER = mean(RER,na.rm=T),
            Activity = mean(Activity, na.rm=T),
            VO2 = mean(`Volume O2`, na.rm=T),
            Heat = mean(Heat,na.rm=T),
            Lean = mean(Lean,na.rm=T)) 

ggplot(animal.data,
       aes(y=VO2, x=Zeitgeber.Time,
           group=Subject,
           col=Knockout)) +
  geom_line() +
  facet_grid(Sex~Subject=='4762'|Subject=='4387')

```

### VO2 Summary Data

```{r vo2-summarized-data, fig.cap="Linegraph of VO2 Data"}

summary.data <-
  animal.data %>%
  ungroup %>%
  select(-Subject, -Genotype) %>% #removed subject column
  group_by(Knockout,Sex,Zeitgeber.Time) %>%
  summarize_all(c('mean','se'))
  
ggplot(summary.data,
       aes(y=VO2_mean,
           ymin=VO2_mean-VO2_se,
           ymax=VO2_mean+VO2_se,
           x=Zeitgeber.Time,
           col=Sex,
           lty=Knockout)) +
  geom_line() +
  geom_errorbar() +
  labs(y="VO2", x="Zeitgeber Time") 

ggplot(summary.data,
       aes(y=VO2_mean,
           ymin=VO2_mean-VO2_se,
           ymax=VO2_mean+VO2_se,
           x=Zeitgeber.Time,
           col=Knockout)) +
  geom_line() +
  geom_errorbar() +
  facet_grid(~Sex) +
  theme_classic() +
  scale_color_manual(labels = c("Wild-Type", "Knockout"), values=c("#6CBE45","#FAC917")) +
  labs(y="Volume O2 Consumed (mL/h)", x="Zeitgeber Time") +
  theme(legend.position = c(0.15, 0.9),
        legend.background = element_rect(fill=alpha(0.1)),
        legend.text=element_text(size=14),
        axis.text=element_text(size=14),
        axis.title=element_text(size=14),
        legend.title=element_blank())
```

# Heat Production

Another way to present these data is to evaluate this by heat instead of VO2. We calculated this manually from VO2 data.  The equation for Heat production from the CLAMS is the Lusk Equation:

$$(3.815 + 1.232 * RER)*VO2$$

```{r heat-production, fig.cap="Linegraph of Heat Data"}


summary.data <-
  animal.data %>%
  ungroup %>%
  select(-Subject, -Genotype) %>% #removed subject column
  group_by(Knockout,Sex,Zeitgeber.Time) %>%
  summarize_all(c('mean','se'))
  
ggplot(summary.data,
       aes(y=Heat_mean,
           ymin=Heat_mean-Heat_se,
           ymax=Heat_mean+Heat_se,
           x=Zeitgeber.Time,
           col=Sex,
           lty=Knockout)) +
  geom_line() +
  geom_errorbar() +
  labs(y="Heat Production (W)", x="Zeitgeber Time") 

ggplot(summary.data,
       aes(y=Heat_mean,
           ymin=Heat_mean-Heat_se,
           ymax=Heat_mean+Heat_se,
           x=Zeitgeber.Time,
           col=Knockout)) +
  geom_line() +
  geom_errorbar() +
  theme_classic() +
  scale_color_manual(labels = c("Wild-Type", "Knockout"), values=c("#6CBE45","#FAC917")) +
  facet_grid(~Sex) +
  labs(y="Heat Production (W)", x="Zeitgeber Time") +
  theme(legend.position = c(0.15, 0.9),
        legend.background = element_rect(fill=alpha(0.1)),
        legend.text=element_text(size=14),
        axis.text=element_text(size=14),
        axis.title=element_text(size=14),
        legend.title=element_blank())
```

## Heat Production Statistics

```{r heat-stats}
model.data <-   
  baseline.data %>%
  filter(Interval>100) %>% #removed first 20 intervals
  filter(RER>0.5) %>%
  filter(RER<1.2) %>%
  filter(!is.na(Lean))

library(lme4)
# bascic model
heat.lme.base <- lmer(Heat ~ as.factor(Time) + (1|Subject), data=model.data, REML=F)

# added lean mass as a covariate
heat.lme.lean <- lmer(Heat ~ as.factor(Time) + Lean + (1|Subject), data=model.data, REML=F)

# added light/dark cycle
heat.lme.ld <- lmer(Heat ~ as.factor(Time) + Lean + `Light/Dark` + (1|Subject), data=model.data, REML=F)

# is there a additive effect of sex
heat.lme.sex <- lmer(Heat ~ as.factor(Time) + Lean + Sex  + (1|Subject), data=model.data, REML=F)
heat.lme.ko <- lmer(Heat ~ as.factor(Time) + Lean + Sex + Knockout + (1|Subject), data=model.data, REML=F)

heat.lme.ko.sex.int <- lmer(Heat ~ as.factor(Time) + Lean + Sex + Knockout + Knockout:Sex + (1|Subject), data=model.data, REML=F)

heat.lme.ko.lc <- lmer(Heat ~ as.factor(Time) + Lean + Sex + `Light/Dark` + Knockout + Knockout:`Light/Dark` + (1|Subject), data=model.data, REML=F)
heat.lme.ko.lc.null <- lmer(Heat ~ as.factor(Time) + Lean + Sex + `Light/Dark` + (1|Subject), data=model.data, REML=F)

heat.lme <- heat.lme.ko.lc
heat.lme.null <- heat.lme.ko.lc.null

animal.data.ld.summary %>% 
  dplyr::select(Knockout,Sex,`Light/Dark`,Heat_mean) %>% 
  spread(key=Knockout,value=Heat_mean) %>%
  mutate(Change = Knockout - Control,
         Pct.Change = Change/Control*100) %>%
  kable(caption="Average changes in heat production comparing wt to knockout")
```

To test whether these groups are different we constructed a linear model with the following formula:

Fat Mass ~ `r as.character(formula(heat.lme))[3]`.  

We used this model because the base model was that Heat production changes over the day.  We asked if lean mass modified the time dependent effect, and it did (p=`r anova(heat.lme.base,heat.lme.lean)$"Pr(>Chisq)"[2]`).  After adjusting for lean mass, we asked if there was any additional benefit to including the light/dark cycle in addition to the time of day, and found that there was no significant effect, so that was not included in the model (p=`r anova(heat.lme.ld,heat.lme.lean)$"Pr(>Chisq)"[2]`).  we added sex as a covariate which had no significant effect `r anova(heat.lme.sex,heat.lme.lean)$"Pr(>Chisq)"[2]`. We chose to keep sex in the model though as it was borderline significant.  We next added knockout to the model and found no significant effect `r anova(heat.lme.sex,heat.lme.ko)$"Pr(>Chisq)"[2]`.  Finally we asked if Sex modified the effect of the knockout and found no significant effect `r anova(heat.lme.ko,heat.lme.ko.sex.int)$"Pr(>Chisq)"[2]`.

Since it appears from the figures that the elevation in energy expenditure is restricted to the awake cycle, we next asked if there was an *interaction* between genotype and the Light/Dark cycle.  Adding this interaction was highly significant `r anova(heat.lme.ko.lc,heat.lme.ko.lc.null)$"Pr(>Chisq)"[2]`.  This represents a 

The full results are shown below:

```{r heat-model}
library(multcomp)
#glht(heat.lme, infct=mcp(Particulate.Treatment='Dunnett')) %>% summary


coefs <- data.frame(coef(summary(heat.lme)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
kable(coefs[25:28,], caption="Estimates and p-values from mixed linear models, excluding time of day.")




# library(influence.ME)
# infl <- influence(heat.lme, group='Subject')
# par(mfrow=c(1,3))
# plot(density(residuals(heat.lme)), las=1)
# plot(fitted(heat.lme),residuals(heat.lme),  
#      ylab="Residuals", xlab="Fitted Values (kW)", pch=19, las=1)
# abline(h=0, lty=2, col='red')
# barplot(cooks.distance(infl), las=2, names.arg=rownames(cooks.distance(infl)), 
#          beside=T, ylab="Cook's Distance", col='grey')
```

## RER Analysis

```{r rer-analysis-light-dark, fig.cap="RER Summary Light/Dark Boxplot"}
ggplot(animal.data.ld,
       aes(y=RER,x=`Light/Dark`,
           col=Knockout)) +
  geom_boxplot(width=0.75) +
  geom_jitter(position=position_dodge(width=0.75)) +
  facet_grid(~Sex)
```

```{r rer-analysis-linegraph, fig,cap="Mouse level RER levels"}
ggplot(animal.data,
       aes(y=RER, x=Zeitgeber.Time,
           group=Subject,
           col=Knockout)) +
  geom_line() +
  facet_grid(~Sex)

```

### RER Summary Data

```{r rer-summarized-data, fig.cap="Linegraph of RER Data"}
ggplot(summary.data,
       aes(y=RER_mean,
           ymin=RER_mean-RER_se,
           ymax=RER_mean+RER_se,
           x=Zeitgeber.Time,
           col=Sex,
           lty=Knockout)) +
  geom_line() +
  geom_errorbar() +
  labs(y="Respiratory Exchange Ratio", x="Zeitgeber Time") 

ggplot(summary.data,
       aes(y=RER_mean,
           ymin=RER_mean-RER_se,
           ymax=RER_mean+RER_se,
           x=Zeitgeber.Time,
           col=Knockout)) +
  geom_line() +
  geom_errorbar() +
  labs(y="Respiratory Exchange Ratio", x="Zeitgeber Time") +
  facet_grid(~Sex) +
  theme_classic() +
  scale_color_manual(labels = c("Wild-Type", "Knockout"), values=c("#6CBE45","#FAC917")) +
  theme(legend.position = c(0.15, 0.9),
        legend.background = element_rect(fill=alpha(0.1)),
        legend.text=element_text(size=14),
        axis.text=element_text(size=14),
        axis.title=element_text(size=14),
        legend.title=element_blank())
```

## Activity Analysis

```{r activity-analysis-light-dark, fig.cap="Activity Summary Light/Dark Boxplot"}
ggplot(animal.data.ld,
       aes(y=Activity,x=`Light/Dark`,
           col=Knockout)) +
  geom_boxplot(width=0.75) +
  geom_jitter(position=position_dodge(width=0.75)) +
  facet_grid(~Sex)
```

```{r activity-analysis-linegraph, fig,cap="Mouse level Activity levels"}
ggplot(animal.data,
       aes(y=Activity, x=Zeitgeber.Time,
           group=Subject,
           col=Knockout)) +
  geom_line() +
  facet_grid(~Sex)

```

### Activity Summary Data

```{r activity-summarized-data, fig.cap="Linegraph of Activity Data"}
ggplot(summary.data,
       aes(y=Activity_mean,
           ymin=Activity_mean-Activity_se,
           ymax=Activity_mean+Activity_se,
           x=Zeitgeber.Time,
           col=Sex,
           lty=Knockout)) +
  geom_line() +
  geom_errorbar() +
  labs(y="Ambulatory Movement", x="Zeitgeber Time") 

ggplot(summary.data,
       aes(y=Activity_mean,
           ymin=Activity_mean-Activity_se,
           ymax=Activity_mean+Activity_se,
           x=Zeitgeber.Time,
           col=Knockout)) +
  geom_line() +
  geom_errorbar() +
  labs(y="Ambulatory Movement", x="Zeitgeber Time") +
  facet_grid(~Sex) +
  theme_classic() +
  scale_color_manual(labels = c("Wild-Type", "Knockout"), values=c("#6CBE45","#FAC917")) +
  theme(legend.position = c(0.15, 0.9),
        legend.background = element_rect(fill=alpha(0.1)),
        legend.text=element_text(size=14),
        axis.text=element_text(size=14),
        axis.title=element_text(size=14),
        legend.title=element_blank())
```


# Interpretation

A brief summary of what the interpretation of these results were

# Session Information

```{r session-information, echo=T}
sessionInfo()
```