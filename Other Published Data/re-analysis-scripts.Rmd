---
title: "Re-Analysis of Other Published Data"
author: "Dave Bridges"
date: "September 6, 2015"
output: html_document
bibliography: references.bib
---


```{r global_options, include=FALSE}
library(knitr)
#figures made will go to directory called figures, will make them as both png and pdf files 
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(scipen = 2, digits = 3)
# set echo and message to TRUE if you want to display code blocks and code output respectively

knitr::knit_hooks$set(inline = function(x) {
  knitr:::format_sci(x, 'md')
})


superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
  arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
  length = length, ...)

  
se <- function(x) sd(x, na.rm=T)/sqrt(length(x))

#load these packages, nearly always needed
library(tidyr)
library(dplyr)

# sets maize and blue color scheme
color.set <- c('#00274c', '#ffcb05')
library("knitcitations")
cleanbib()
options("citation_format" = "pandoc")

```

This script is for the re-analysis of previously published data from other groups.  This is often for presentations wherein the data was presented as a table or something and we want to draw attention to a particular aspect.  This script was most recently run on `r date()`.

# Ebbeling et al JAMA 2012 Paper

The paper `r citep('10.1001/jama.2012.6607')` used subjects who lost 12% of their weight, then had their weight stabilized.  They used a crossover design to test weight maintenance on low carbohydrate, or high carbohydrate diet.  They also used a high glycemic index diet that we are ignoring here.

```{r ebbeling-bargraphs, fig.cap="Effect of Maintenance Diet on Energy Expenditure After Weight Loss"}
ebbeling_datafile <- 'Ebbeling JAMA 2012 Table 3.csv'
ebbeling.data <- read.csv(ebbeling_datafile)
#calculate SE from 95% CI
ebbeling.data$TEE.SE <- ebbeling.data$TEE.95ci/qt(0.975, df=2)

superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
length = length, ...)

ymax <- max(ebbeling.data$TEE + ebbeling.data$TEE.SE)
plot <- barplot(ebbeling.data$TEE,
                las=1, ylab="Total Energy Expenditure (kcal/FFM/day)",
                col=c(grey.colors(3)[2],color.set),
                ylim=c(2500,ymax),xpd=F,
                names.arg=c("Baseline","High Carbohydrate", "High Fat/Protein"))

superpose.eb(plot, ebbeling.data$TEE, ebbeling.data$TEE.SE)
```

The data from Table 2 of `r citet('Ebbeling_2012')` was re-entered as `r ebbeling_datafile`.

```{r ebbeling-barplot-decrease}
ebbeling.data$Decrease <- (ebbeling.data$TEE - ebbeling.data$TEE[1])*4.18400
ebbeling.data$Decrease.SE <- sqrt(ebbeling.data$TEE.SE^2 + ebbeling.data$TEE.SE[1]^2)*4.18400

par(mar=c(5, 7, 4, 2))
ymax <- min(ebbeling.data$Decrease - ebbeling.data$Decrease.SE)
plot <- barplot(ebbeling.data$Decrease[2:3],
                las=1, ylab="Change in Energy \nExpenditure (kJ/day)",
                col=color.set,cex.names=1.5, cex.lab=1.5,
                ylim=c(ymax,0),
                names.arg=c("High Carbohydrate", "High Fat/Protein"))

superpose.eb(plot, ebbeling.data$Decrease[2:3], ebbeling.data$Decrease.SE[2:3])
```

# Bray et al Overfeeding Study

In `r citet('10.1001/jama.2011.1918')`, subjects were overfed for 8 weeks with equal calories of low, normal (not included here) and high protein diet.  Total energy expenditure is taken from the Table in this paper.

```{r bray-bargraph, fig.cap="Effect of Diet on Energy Expenditure After 8 Weeks of Overfeeding"}
bray_datafile <- 'Bray JAMA 2012 Table.csv'
bray.data <- read.csv(bray_datafile)
#calculate SE from 95% CI
bray.data$TEE.SE <- bray.data$TEE.95ci/qt(0.975, df=2)

par(mar=c(5, 7, 4, 2))
ymax <- max(bray.data$TEE + bray.data$TEE.SE)
plot <- barplot(bray.data$TEE,
                las=1, ylab="Change in Energy \nExpenditure (kJ/day)",
                col=color.set,cex.names=1.5,cex.lab=1.5,
                ylim=c(0,ymax),xpd=F,
                names.arg=bray.data$Condition)

superpose.eb(plot, bray.data$TEE, bray.data$TEE.SE)
```

The data from the table was re-entered as `r bray_datafile`.

## Bray et al Follow-Up Study

In a follow up study, `r citet('10.3945/ajcn.114.091769')` looked at the energy expenditure in a tissue specific manner via DEXA scans.

```{r bray-tissue-bargraph, fig.cap="Effect of Diet on Energy Expenditure in Adipose and Muscle"}

#calculate SD from SE
bray.data$Adipose.SE <- bray.data$Adipose.SD/sqrt(bray.data$n)
bray.data$Muscle.SE <- bray.data$Muscle.SD/sqrt(bray.data$n)

ymax <- max(bray.data$Muscle + bray.data$Muscle.SE)
plot <- barplot(cbind(bray.data$Muscle,bray.data$Adipose),
                las=1, ylab="Energy Expenditure",
                col=color.set,cex.names=2,
                ylim=c(0,ymax),beside=T,
                names.arg=c('Muscle','Adipose'))

superpose.eb(plot,
             cbind(bray.data$Muscle,bray.data$Adipose),
             cbind(bray.data$Muscle.SE,bray.data$Adipose.SE))
legend('topright',levels(as.factor(bray.data$Condition)), bty='n', fill=color.set)
```


## Ravussin AJCN

Ravussin *et al*, `r citet('10.1093/ajcn/35.3.566')` looked at the energy expenditure in men and women of differing obesity status.

```{r ravussin-energy-expenditure}
ravussin.paper <- 'Ravussin AJCN 1982.csv' 

ravussin.data <- read.csv(ravussin.paper)

library(ggplot2)
ravussin.data %>%
  ggplot(aes(y=TDEE,
             x=Group,
             fill=Group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  facet_grid(~Sex) +
  labs(y="TDEE (kJ/24h)",
       x="",
       title="Data from Ravussin et al, 1982") +
  theme_classic() +
  theme(text = element_text(size=14),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
  
tdee.lm <- lm(TDEE ~ Sex + Age, data=ravussin.data)

ravussin.data <-
  ravussin.data %>%
  mutate(Residuals= residuals(tdee.lm),
         Predicted = predict(tdee.lm))

ravussin.data %>%
  ggplot(aes(y=Residuals,
             x=Group,
             fil=Group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  facet_grid(~Sex) +
  labs(y="Total Daily Energy Expenditure",
       x="",
       title="Data from Ravussin et al, 1982",
       subtitle="After adjustment for Age and Sex") +
  theme_classic() +
  theme(text = element_text(size=14),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```

# Seyssel et al 2014

```{r seyssel-geo}
# Version info: R 3.2.3, Biobase 2.30.0, GEOquery 2.40.0, limma 3.26.8
################################################################
#   Differential expression analysis with limma
library(GEOquery)
library(limma)
library(umap)

# load series and platform data from GEO

gset <- getGEO("GSE50484", GSEMatrix =TRUE, AnnotGPL=TRUE)
if (length(gset) > 1) idx <- grep("GPL570", attr(gset, "names")) else idx <- 1
gset <- gset[[idx]]

# make proper column names to match toptable 
fvarLabels(gset) <- make.names(fvarLabels(gset))

# group membership for all samples
gsms <- "010101010101010101010101"
sml <- strsplit(gsms, split="")[[1]]

# pairing membership for all samples
sml.pair <- c(1,1,3,3,5,5,6,6,8,8,9,9,11,11,16,16,17,17,18,18,19,19,20,20)

# log2 transformation
ex <- exprs(gset)
qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm=T))
LogC <- (qx[5] > 100) ||
          (qx[6]-qx[1] > 50 && qx[2] > 0)
if (LogC) { ex[which(ex <= 0)] <- NaN
  exprs(gset) <- log2(ex) }

# assign samples to groups and set up design matrix
gs <- factor(sml)
groups <- make.names(c("Baseline","Overfed"))
levels(gs) <- groups
gset$group <- gs
#assign pairs
pairs <- factor(sml.pair)
gset$subject <- pairs

design <- model.matrix(~subject+group, gset)
#colnames(design) <- levels(gs)

fit <- lmFit(gset, design)  # fit linear model
fit <- eBayes(fit)
# set up contrasts of interest and recalculate model coefficients
# cts <- paste(groups[1], groups[2], sep="-")
# cont.matrix <- makeContrasts(contrasts=cts, levels=design)
# fit2 <- contrasts.fit(fit, cont.matrix)

# compute statistics and table of top significant genes
# fit2 <- eBayes(fit2, 0.01)
 tT <- topTable(fit, adjust="fdr", sort.by="P", coef="groupOverfed", number=25)

tT <- subset(tT, select=c("ID","adj.P.Val","P.Value","t","B","logFC","Gene.symbol","Gene.title"))
kable(tT)

# Visualize and quality control test results.
# Build histogram of P-values for all genes. Normal test
# assumption is that most genes are not differentially expressed.
tT2 <- topTable(fit, adjust="fdr", sort.by="B", number=Inf)
hist(tT2$adj.P.Val, col = "grey", border = "white", xlab = "P-adj",
  ylab = "Number of genes", main = "P-adj value distribution")

# summarize test results as "up", "down" or "not expressed"
dT <- decideTests(fit, adjust.method="fdr", p.value=0.05)

# Venn diagram of results
#vennDiagram(dT, circle.col=palette())

# create Q-Q plot for t-statistic
t.good <- which(!is.na(fit$F)) # filter out bad probes
qqt(fit$t[t.good], fit$df.total[t.good], main="Moderated t statistic")

# volcano plot (log P-value vs log fold change)
colnames(fit) # list contrast names
ct <- 1        # choose contrast of interest
volcanoplot(fit, coef=ct, main=colnames(fit)[ct], pch=20,
  highlight=length(which(dT[,ct]!=0)), names=rep('+', nrow(fit)))

# MD plot (log fold change vs mean log expression)
# highlight statistically significant (p-adj < 0.05) probes
plotMD(fit, column=ct, status=dT[,ct], legend=F, pch=20, cex=1)
abline(h=0)

################################################################
# General expression data analysis
ex <- exprs(gset)

# box-and-whisker plot
ord <- order(gs)  # order samples by group
palette(c("#1B9E77", "#7570B3", "#E7298A", "#E6AB02", "#D95F02",
          "#66A61E", "#A6761D", "#B32424", "#B324B3", "#666666"))
par(mar=c(7,4,2,1))
title <- paste ("GSE50484", "/", annotation(gset), sep ="")
boxplot(ex[,ord], boxwex=0.6, notch=T, main=title, outline=FALSE, las=2, col=gs[ord])
legend("topleft", groups, fill=palette(), bty="n")

# expression value distribution
par(mar=c(4,4,2,1))
title <- paste ("GSE50484", "/", annotation(gset), " value distribution", sep ="")
plotDensities(ex, group=gs, main=title, legend ="topright")

# UMAP plot (dimensionality reduction)
ex <- na.omit(ex) # eliminate rows with NAs
ex <- ex[!duplicated(ex), ]  # remove duplicates
ump <- umap(t(ex), n_neighbors = 10, random_state = 123)
par(mar=c(3,3,2,6), xpd=TRUE)
plot(ump$layout, main="UMAP plot, nbrs=10", xlab="", ylab="", col=gs, pch=20, cex=1.5)
legend("topright", inset=c(-0.15,0), legend=levels(gs), pch=20,
col=1:nlevels(gs), title="Group", pt.cex=1.5)
library("maptools")  # point labels without overlaps
pointLabel(ump$layout, labels = rownames(ump$layout), method="SANN", cex=0.6)

# mean-variance trend, helps to see if precision weights are needed
plotSA(fit, main="Mean variance trend, GSE50484")
```

```{r bibliography, results='asis'}
write.bibtex(file="references.bib")
bibliography()
```


# Session Information

```{r session-info, results='asis'}
sessionInfo()
```

# Bibliography